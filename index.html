<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Expense & Income Manager</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px 10px; }
  </style>
</head>
<body>
  <h1>Expense & Income Manager</h1>
  <button id="authorize_button">Sign in with Google</button>
  <button id="signout_button" style="display:none">Sign Out</button>

  <h2>Accounts</h2>
  <button id="addAccount">Add Account</button>
  <table id="accounts"><tr><th>Name</th><th>Balance</th><th>Actions</th></tr></table>

  <h2>Transactions</h2>
  <button id="addTransaction">Add Transaction</button>
  <table id="transactions"><tr><th>Date</th><th>Account</th><th>Type</th><th>Amount</th><th>Envelope</th><th>Actions</th></tr></table>

  <h2>Envelopes</h2>
  <button id="addEnvelope">Add Envelope</button>
  <table id="envelopes"><tr><th>Name</th><th>Allocated</th><th>Spent</th></tr></table>

<script>
const CLIENT_ID = "YOUR_CLIENT_ID.apps.googleusercontent.com"; 
const API_KEY = "YOUR_API_KEY";
const SPREADSHEET_ID = "YOUR_SPREADSHEET_ID";
const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

let data = { accounts: [], transactions: [], envelopes: [] };

function gapiLoaded() { gapi.load("client:auth2", initClient); }

async function initClient() {
  await gapi.client.init({ apiKey: API_KEY, clientId: CLIENT_ID, discoveryDocs: DISCOVERY_DOCS, scope: SCOPES });
  gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
  updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
  document.getElementById("authorize_button").onclick = () => gapi.auth2.getAuthInstance().signIn();
  document.getElementById("signout_button").onclick = () => gapi.auth2.getAuthInstance().signOut();
}

function updateSigninStatus(isSignedIn) {
  document.getElementById("authorize_button").style.display = isSignedIn ? "none" : "block";
  document.getElementById("signout_button").style.display = isSignedIn ? "block" : "none";
  if (isSignedIn) { loadData(); }
}

// ---------- Data Management ----------
async function loadData() {
  const accRes = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "Accounts!A2:B" });
  data.accounts = (accRes.result.values || []).map(r => ({ name: r[0], start: parseFloat(r[1]||0) }));

  const txRes = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "Transactions!A2:F" });
  data.transactions = (txRes.result.values || []).map(r => ({
    date: r[0], account: r[1], type: r[2], amount: parseFloat(r[3]||0), envelope: r[4], id: r[5]
  }));

  const envRes = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: "Envelopes!A2:B" });
  data.envelopes = (envRes.result.values || []).map(r => ({ name: r[0], allocated: parseFloat(r[1]||0) }));

  render();
}

async function saveData() {
  // Accounts
  await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SPREADSHEET_ID, range: "Accounts!A2:B" });
  if (data.accounts.length) {
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID, range: "Accounts!A2", valueInputOption: "RAW",
      resource: { values: data.accounts.map(a => [a.name, a.start]) }
    });
  }
  // Transactions
  await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SPREADSHEET_ID, range: "Transactions!A2:F" });
  if (data.transactions.length) {
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID, range: "Transactions!A2", valueInputOption: "RAW",
      resource: { values: data.transactions.map(t => [t.date,t.account,t.type,t.amount,t.envelope,t.id]) }
    });
  }
  // Envelopes
  await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SPREADSHEET_ID, range: "Envelopes!A2:B" });
  if (data.envelopes.length) {
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID, range: "Envelopes!A2", valueInputOption: "RAW",
      resource: { values: data.envelopes.map(e => [e.name,e.allocated]) }
    });
  }
}

// ---------- UI ----------
function render() {
  // Accounts
  const accountBalances = data.accounts.map(a => {
    const spent = data.transactions.filter(t => t.account===a.name && t.type==="expense").reduce((s,t)=>s+t.amount,0);
    const income = data.transactions.filter(t => t.account===a.name && t.type==="income").reduce((s,t)=>s+t.amount,0);
    return { name:a.name, balance:a.start+income-spent, start:a.start };
  });
  document.getElementById("accounts").innerHTML = "<tr><th>Name</th><th>Balance</th><th>Actions</th></tr>" +
    accountBalances.map((a,i) => `<tr>
      <td>${a.name}</td>
      <td>$${a.balance.toFixed(2)}</td>
      <td><button onclick="editAccount(${i})">Edit</button></td>
    </tr>`).join("");

  // Transactions
  document.getElementById("transactions").innerHTML = "<tr><th>Date</th><th>Account</th><th>Type</th><th>Amount</th><th>Envelope</th><th>Actions</th></tr>" +
    data.transactions.map((t,i) => `<tr>
      <td>${t.date}</td><td>${t.account}</td><td>${t.type}</td><td>$${t.amount}</td><td>${t.envelope}</td>
      <td><button onclick="editTransaction(${i})">Edit</button><button onclick="deleteTransaction(${i})">Delete</button></td>
    </tr>`).join("");

  // Envelopes
  document.getElementById("envelopes").innerHTML = "<tr><th>Name</th><th>Allocated</th><th>Spent</th></tr>" +
    data.envelopes.map(e => {
      const spent = data.transactions.filter(t=>t.envelope===e.name && t.type==="expense").reduce((s,t)=>s+t.amount,0);
      return `<tr><td>${e.name}</td><td>$${e.allocated}</td><td>$${spent}</td></tr>`;
    }).join("");
}

// ---------- Actions ----------
document.getElementById("addAccount").onclick = () => {
  const name = prompt("Account name:"); if (!name) return;
  const startBal = parseFloat(prompt("Starting balance:", "0"))||0;
  data.accounts.push({ name, start:startBal });
  saveData(); render();
};

window.editAccount = (i) => {
  const acc = data.accounts[i];
  const action = prompt(
    `Editing account: ${acc.name}\nChoose an option:\n1 = Rename\n2 = Edit Starting Balance\n3 = Delete`,
    "1"
  );

  if (action === "1") {
    const newName = prompt("Enter new account name:", acc.name);
    if (newName) data.accounts[i].name = newName;
  } else if (action === "2") {
    const newStart = parseFloat(prompt("Enter new starting balance:", acc.start));
    if (!isNaN(newStart)) data.accounts[i].start = newStart;
  } else if (action === "3") {
    if (confirm(`Are you sure you want to delete account "${acc.name}"?`)) {
      // also delete related transactions
      data.transactions = data.transactions.filter(t => t.account !== acc.name);
      data.accounts.splice(i, 1);
    }
  }

  saveData();
  render();
};

document.getElementById("addTransaction").onclick = () => {
  const date = prompt("Date (YYYY-MM-DD):", new Date().toISOString().slice(0,10));
  const account = prompt("Account:", data.accounts[0]?.name || "");
  const type = prompt("Type (income/expense):","expense");
  const amount = parseFloat(prompt("Amount:","0"));
  const envelope = prompt("Envelope (optional):","");
  const id = Math.random().toString(36).substr(2,9);
  data.transactions.push({ date,account,type,amount,envelope,id });
  saveData(); render();
};
window.editTransaction = (i) => {
  const t = data.transactions[i];
  t.date = prompt("Date:", t.date)||t.date;
  t.account = prompt("Account:", t.account)||t.account;
  t.type = prompt("Type (income/expense):", t.type)||t.type;
  t.amount = parseFloat(prompt("Amount:", t.amount))||t.amount;
  t.envelope = prompt("Envelope:", t.envelope)||t.envelope;
  saveData(); render();
};
window.deleteTransaction = (i) => { data.transactions.splice(i,1); saveData(); render(); };

document.getElementById("addEnvelope").onclick = () => {
  const name = prompt("Envelope name:"); if (!name) return;
  const allocated = parseFloat(prompt("Allocated amount:","0"))||0;
  data.envelopes.push({ name,allocated });
  saveData(); render();
};
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>
